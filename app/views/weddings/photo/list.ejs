<%- include('../../layout/admin/_head') -%>
<!-- Content Header (Page header) -->
<section class="content-header form-inline">
    <h1>List <%= mod_alias%><small><a href="<%= mod_url%>"><i class="fa fa-refresh"></i></a></small>
    </h1>
    <ol class="breadcrumb pull-right">
        <li><a href="<%= mod_url%>"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active"><%= mod_alias%></li>
    </ol>
</section>
<div class="clearfix"></div>

<section class="content-header">
    <form class="form-inline">
        <div class="form-group">
            <input type="text" name="from_date"  value="<%=helpers.admin.get_query_data(query_get,'from_date')%>" class="form-control datepicker" placeholder="From date">
            <input type="text" name="to_date"  value="<%=helpers.admin.get_query_data(query_get,'to_date')%>" class="form-control datepicker" placeholder="To date">
            <input type="text" name="where"  value="<%=helpers.admin.get_query_data(query_get,'where')%>" class="form-control " style="min-width: 500px;" placeholder="Condition Advance">
        </div>
        <button type="submit" class="btn btn-primary">Filter</button>
        <div class="right pull-right">
            <%- helpers.admin.render_menu_buttons(mod_route,admin_userdata)%>
        </div>
    </form>
</section>
<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <form action="<%= mod_url%>/delete" class="JsDeleteForm" method="post">
                    <div class="box-header">
                        <h3 class="box-title">Total: <%= total_record%> records</h3>
                    </div>

                    <!-- /.box-header -->
                    <div class="box-body table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <% if(helpers.admin.checkPerm('delete',admin_userdata)){ %>
                                <th class="col_checkbox">
                                    <div class="checkbox">
                                        <input id="checkbox_all" class="styled" type="checkbox">
                                        <label for="checkbox_all"></label>
                                    </div>
                                </th>
                                <%}%>
                                <% Object.keys(fields).forEach(function(field){ %>
                                <% let field_type = fields[field]; %>
                                <th class="sorting">
                                    <%- helpers.admin.sort_field(field, curent_url)%>
                                    <div class="filter_sort">
                                        <a href="javascript:void(0);" data-filter="filter_<%= field%>" data-toggle="hide" class="filter"><i class="fa fa-filter"></i></a>
                                    </div>
                                    <br>
                                    <div class="wrapper_filter">
                                        <% if(field_type == 'Boolean'){ %>
                                        <select onchange="Admin.filter_submit();" class="form-control filter_field hide filter_<%= field%>" name="<%= field%>">
                                            <option value=""></option>
                                            <option <% if(helpers.admin.get_query_data(query_get,field) == 'true'){%> selected <%}%> value="true">Active</option>
                                            <option <% if(helpers.admin.get_query_data(query_get,field) == 'false'){%> selected <%}%> value="false">Disable</option>
                                        </select>
                                        <% }else{ %>
                                        <input class="filter_field hide filter_<%= field%> <% if (field_type == 'Date') { %>datepicker<%}%>" name="<%= field%>" type="text" value="<%=helpers.admin.get_query_data(query_get,field)%>">
                                        <% } %>
                                    </div>
                                </th>
                                <% }); %>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% if (lists.length > 0) { %>
                            <% lists.forEach(function(row) { %>
                            <tr>
                                <% if(helpers.admin.checkPerm('delete',admin_userdata)){ %>
                                <td class="col_checkbox">
                                    <div class="checkbox">
                                        <input id="checkbox<%= row._id%>" class="styled" type="checkbox" name="listViewId" value="<%= row._id%>">
                                        <label for="checkbox<%= row._id%>"></label>
                                    </div>
                                </td>
                                <%}%>
                                <% Object.keys(fields).forEach(function(field){ %>
                                    <% if (field == "image" || field == "link") { %>
                                        <td>
                                            <img src="https://drive.google.com/thumbnail?id=<%=row['id_image']%>&sz=s100`" />
                                        </td>
                                    <% } else if (field == "tags") { %>
                                      <td style="width: 200px !important;">
                                        <%- helpers.admin.get_field_value_custom(field, row[field], fields[field])%>
                                        <i class="fa fa-edit edit-tag" data-id="<%= row._id %>"></i>
                                          <div class="tag-result-<%= row._id %>" style="display: none;" width="100%"></div>
                                        
                                          <div class="tag-show-<%= row._id %>" style="display: none;" width="100%">
                                            <textarea
                                              rows="2"
                                              cols="2"
                                              class="form-control medium tag-input"
                                              name="tags-<%= row._id %>"
                                              id="tags-<%= row._id %>"
                                              placeholder="Add tags"><%= row[field] ? row[field].join(', ') : '' %></textarea>

                                            <button
                                              type="button"
                                              class="btn btn-primary btn-sm btn-add-tag"
                                              data-id="<%= row._id %>"
                                              style="margin-top: 5px;">
                                              Add Tags
                                            </button>
                                          </div>
                                        
                                      </td>
                                    <% } else { %>
                                        <td>
                                            <%- helpers.admin.get_field_value_custom(field, row[field], fields[field])%>
                                        </td>
                                    <% } %>
                                <% }); %>

                                <td>
                                    <%- helpers.admin.render_action_buttons(row._id,mod_route,admin_userdata)%>
                                </td>

                            </tr>
                            <% }); %>
                            <% } else { %>
                            <tr>
                                <td colspan="<%=  Object.keys(fields).length + 10 %>">No data.</td>
                            </tr>
                            <% } %>
                            </tbody>
                        </table>
                        <ul class="pagination pull-left">
                            <%- output_paging%>
                        </ul>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>
</div><!--/.content-wrapper-->
<%- include('../../layout/admin/_footer') -%>
<%- include('../../layout/admin/_end') -%>

<script>
  $(document).ready(function () {
    // Click edit icon → show textarea
    $(document).on('click', '.edit-tag', function () {
      $(this).hide();
      const id = $(this).data('id');
      $('.tag-show-' + id).slideToggle();
    });

    // Click Add Tags → send data to server
    $(document).on('click', '.btn-add-tag', function () {
      const id = $(this).data('id');
      const tags = $('#tags-' + id).val();

      if (!tags.trim()) {
        alert('Please enter tags');
        return;
      }

      $.ajax({
        url:   '<%= mod_url%>/add-tags', // API của bạn
        type: 'POST',
        data: {
          id: id,
          tags: tags,
          _csrf: token_value 
        },
        success: function (res) {
          // alert('Tags added successfully');
          let htmklTags = '';
          htmklTags += '<div class="render-field">';
          tags.split(",").forEach(function(tag, index) {
            htmklTags += "<span class='label label-info' style='margin-right:5px;'>" + tag.trim() + "</span>";
          });
          htmklTags += '</div>';

          // Optional: hide form after success
          $('.tag-show-' + id).slideUp();
          $('.tag-result-' + id).html(htmklTags).show();
        },
        error: function () {
          alert('Error adding tags');
        }
      });
    });
  });
</script>

