<%- include('../../layout/admin/_head') -%>
<!-- Content Header (Page header) -->
<section class="content-header form-inline">
    <h1>Report <%= mod_alias%><small><a href="<%= mod_url%>"><i class="fa fa-refresh"></i></a></small>
    </h1>
    <ol class="breadcrumb pull-right">
        <li><a href="<%= mod_url%>"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active"><%= mod_alias%></li>
    </ol>
</section>
<div class="clearfix"></div>

<section class="content-header">
    <form class="form-inline">
        <div class="form-group">
            <input type="text" name="from_date"  value="<%=helpers.admin.get_query_data(query_get,'from_date')%>" class="form-control datepicker" placeholder="From date">
            <input type="text" name="to_date"  value="<%=helpers.admin.get_query_data(query_get,'to_date')%>" class="form-control datepicker" placeholder="To date">
        </div>
        <button type="submit" class="btn btn-primary">Filter</button>
        <!-- <div class="right pull-right">
            <%- helpers.admin.render_menu_buttons(mod_route,admin_userdata)%>
        </div> -->
    </form>
</section>
<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title"><i class="fa fa-line-chart"></i> Chart</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <!-- Update chart -->
                    <div style="float: right;">
                        <button type="button" class="btn-type-chart btn btn-flat btn-primary btn-sm hidden"
                            data-type="spline">
                            <i class="fa fa-line-chart"></i> Số lượng
                        </button>
                        <button type="button" class="btn-type-chart btn btn-flat btn-primary btn-sm" data-type="column">
                            <i class="fa fa-percent"></i> Tỉ lệ
                        </button>
                    </div>
                    <!-- Chart Area -->
                    <div class="chart">
                        <figure class="highcharts-figure">
                            <div id="container"></div>
                            <div class="highcharts-description">
                                <!-- data metrics -->
                                <div class="metrics metrics-data custom pull-right" style="display: none;">
                                    <div class="dropdown">
                                        <button type="button" class="btn btn-default btn-sm dropdown-toggle"
                                            data-toggle="dropdown" aria-expanded="false">
                                            <i class="fa fa-cog"></i> Data Metrics <i class="fa fa-caret-down"></i>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right">
                                            <p class="dropdown-header text-center">Customize Columns</p>
                                            <form class="dropdown-cb" aria-labelledby="dropdownMenuButton">
                                                <div class="form-check form-check-inline">
                                                    <label class="form-check-label">
                                                        <input class="form-check-input" #checked type="checkbox" name=""
                                                            data-col="#col" value="#value">
                                                        #value
                                                    </label>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <!-- data table -->
                                <table id="data" class="table table-striped table-bordered" style="width:100%">
                                    <tfoot>
                                        <tr>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </figure>
                    </div>
                </div>
                <!-- /.box-body -->
            </div>
        </div>
    </div>
</section>
</div>
<!--/.content-wrapper-->
<%- include('../../layout/admin/_footer') -%>
<%- include('../../layout/admin/_end') -%>

<script src="<%=publicUrl%>admin/js/highcharts/highstock.js"></script>
<script src="<%=publicUrl%>admin/js/highcharts/drilldown.js"></script>

<script src="<%=publicUrl%>admin/js/highcharts/exporting.js"></script>
<script src="<%=publicUrl%>admin/js/highcharts/export-data.js"></script>
<!-- <script src="<%=publicUrl%>admin/js/highcharts/accessibility.js"></script> -->
<script src="<%=publicUrl%>admin/js/highcharts/no-data-to-display.js"></script>


<!-- datatables -->
<link rel="stylesheet" type="text/css" href="<%=publicUrl%>admin/js/datatables/datatables.min.css" />
<script type="text/javascript" src="<%=publicUrl%>admin/js/datatables/datatables.min.js"></script>

<script>
    var locale = 'vi-VN';
    var chart, table;
    var $table = $('#data')
    var reqTo = null,
        timeout = 3000;

    // Date range filter
    var minDateFilter = "",
        maxDateFilter = "";
    var $dropMenu = $('.metrics .dropdown-menu')
    var $dropdown = $dropMenu.find('.dropdown-cb')
    var cbTemplate = $dropdown.html()
    var numFormat = $.fn.dataTable.render.number(',', '.', 0, '')
    var percentFormat = $.fn.dataTable.render.number(',', '.', 2, '', '%')
    var startDate = "<%=helpers.admin.get_query_data(query_get,'from_date')%>";
    var endDate = "<%=helpers.admin.get_query_data(query_get,'to_date')%>";
    const metrics = <%-JSON.stringify(Object.keys(statuscode).reduce((trans, cur) => {
        trans[statuscode[cur].ID] = {
            name: mod_resource + ".status." + cur,
        };
        return trans;
    }, {
        total: {
            name: 'Total',
            type: 'column',
            opacity: 0.5
        }
    } )) %>;

    // sum report by date
    function sumReportByDate(metrics, data) {
        const reportsByDate = {}
        data.forEach(function (item) {
            if (reportsByDate[item._id.date]) {
                reportsByDate[item._id.date][item._id.status] = item.total
                reportsByDate[item._id.date].total += item.total
            } else {
                reportsByDate[item._id.date] = {
                    _id: {
                        date: moment(item._id.date).valueOf()
                    },
                    ...Object.keys(metrics).reduce(function (t, k) {
                        t[k] = 0
                        return t
                    }, {}),
                    [item._id.status]: item.total,
                    total: item.total,
                }
            }
        })
        // debugger
        const accumulateSum = [{
            false: 0,
            true: 0,
            total: 0,
            gifts: {
                true: [],
                false: []
            }
        }]
        // sort by date
        return Object.values(reportsByDate).sort(function (a, b) {
            return a._id.date - b._id.date
        })
    }


    // create or update data table
    function getDataTable(metrics, data, updateTable) {
            if (!table) {
                var columns = Object.keys(metrics).map(function (field) {
                    var f = metrics[field]
                    var col = { data: field, title: f.name, render: numFormat, className: 'text-left', visible: true }
                    if (field === 'shareRatio') {
                        col.render = function (data, type, row) {
                            return percentFormat.display(data)
                        }
                    }
                    return col
                })

                if ($dropdown.length) {
                    $dropdown.html(Object.keys(metrics).map(function (field, i) {
                        return cbTemplate.replace(/\#value/g, metrics[field].name).replace(/\#col/, i).replace(/\#checked/, 'checked')
                    }).join('')).closest('.metrics').css('display', 'block')
                }

                columns.unshift({
                    data: '_id.date',
                    title: 'Ngày',
                    render: function (data, type, row, meta) {
                        return moment(data).format("YYYY-MM-DD");
                    }
                })
                columns.forEach(function () {
                    $table.find('tfoot tr').append('<th></th>');
                })
                table = $table.DataTable({
                    data: data,
                    columns: columns,
                    scrollX: true,
                    scrollCollapse: true,
                    select: true,
                    fixedColumns: {
                        leftColumns: 1
                    },
                    order: [[0, "desc"]],
                    initComplete: function (settings, json) {
                        $('body').find('.dataTables_scrollBody').addClass("table-responsive");
                    },
                    drawCallback: function (row, data, start, end, display) {
                        var api = this.api();
                        api.columns({ search: 'applied' }).every(function (i) {
                            if (i == 0) {
                                $(this.footer()).html("Total");
                            } else {
                                var sum = this
                                    .data()
                                    .reduce(function (a, b) {
                                        var x = parseFloat(a) || 0;
                                        var y = parseFloat(b) || 0;
                                        return x + y;
                                    }, 0);
                                // Update footer
                                $(this.footer()).html(numFormat.display(sum));
                            }
                        });
                    },
                    orderCellsTop: true,
                    responsive: true,
                    language: {
                        emptyTable: "No data"
                    }
                })
                setTimeout(function () {
                    table.draw();
                }, 1)
            } else if (typeof(updateTable) == 'function') {
                updateTable(data)
            } else {

            }
        }

    // create or update chart
    function getChart(metrics, data, drawChart) {
        console.log(metrics,'metrics')
        var cData = []
        Object.keys(metrics).forEach(function (field, i) {
            var f = metrics[field]
            var series = {
                name: f.name,
                data: data.map(function (d, i) {
                    return [d._id.date, d[field]]
                    return dt
                }),
                type: f.type || 'spline',
                visible: true,
                lineWidth: 2,
                color: f.color,
                yAxis: 0 + (f.yAxis || 0),
                marker: {
                    radius: 3,
                    enabled: (data.length == 1),
                },
                opacity: f.opacity,
            }
            if (f.unit) series.tooltip = {
                valueSuffix: f.unit
            }
            cData.push(series)
        })
        if (chart.series.length <= 0) {
            // create chart
            var interval = setInterval(function () {
                if (cData.length <= 0) {
                    clearInterval(interval)
                }
                chart.addSeries(cData.shift())
            }, 100)
        } else if (typeof (drawChart) == 'function') {
            // update chart cb
            drawChart(cData)
        } else {

        }
    }

    function changeType(chart, newType) {
        chart.showLoading()
        var serie;
        if (newType === 'column') {
            for (var i = 0; i < chart.series.length; i++) {
                serie = chart.series[0];
                serie.chart.addSeries({
                    type: newType,
                    name: serie.name,
                    data: serie.options.data,
                    color: serie.color,
                    stacking: 'percent',
                    visible: serie.name !== 'Total',
                    showInLegend: serie.name !== 'Total',
                }, false);
                serie.remove(false);
            }
            chart.yAxis[0].update({
                title: {
                    text: 'Percent'
                }
            })
            chart.title.update({
                text: 'Tỉ lệ theo ngày'
            })
        } else {
            for (var i = 0; i < chart.series.length; i++) {
                serie = chart.series[0];
                serie.chart.addSeries({
                    type: serie.name === 'Total' ? metrics.total.type : newType,
                    name: serie.name,
                    data: serie.options.data,
                    lineWidth: 2,
                    color: serie.color,
                    marker: {
                        radius: 3,
                        enabled: (data.length == 1),
                    },
                    opacity: serie.name === 'Total' ? metrics.total.opacity : 1,
                }, false);
                serie.remove(false);
            }
            chart.yAxis[0].update({
                title: {
                    text: 'Number'
                }
            })
            chart.title.update({
                text: 'Số lượng theo ngày'
            })
        }
        chart.redraw();
        chart.hideLoading()
    }

    /**
     * Request data from the server, add it to the graph and set a timeout
     * to request again
     */
    function requestData() {
        var data = {
            _csrf: token_value,
            startDate: startDate,
            endDate: endDate,
        }
        $.ajax({
            url: '<%=mod_url%>/report?<%-query_string%>',
            method: 'POST',
            data: data,
            dataType: 'json',
            cache: false,
            success: function (resp) {
                if (resp.status == 200 && resp.msg == 'Success') {
                    if (resp.data && resp.data.length > 0) {
                        const reportsByDate = sumReportByDate(metrics, resp.data)
                        // draw chart
                        getChart(metrics, reportsByDate, function (data) {
                            if (!chart) return
                            // add data chart
                            for (var j = 0; j < data.length; j++) {
                                var seriesData = data[j].data
                                for (var i = 0; i < seriesData.length; i++) {
                                    chart.series[j].addPoint(seriesData[i], false, false);
                                }
                            }
                            chart.redraw()
                        })

                        getDataTable(metrics, reportsByDate, function (data) {
                                table.rows.add(data).draw(false);
                            })

                        timeout = 3000
                    } else {
                        timeout = 1
                    }
                    if (typeof (callback) == 'function') {
                        callback(resp.data)
                    }
                } else {
                    timeout = 1
                }
            },
            error: function (err) {
                console.error(err)
            },
            complete: function () {
                setTimeout(function () {
                    chart.hideLoading();
                    if (!chart.hasData()) {
                        chart.showNoData();
                    }
                }, 1)
            }
        });
    }

    function initializeChart() {
        if (chart) return
        chart = new Highcharts.stockChart({
            chart: {
                renderTo: 'container',
                zoomType: 'x',
                borderWidth: 1,
                borderColor: '#ccc',
                spacingBottom: 30,
                height: 600,
                events: {
                    load: function () {
                        requestData()
                    },
                    drillupall: function () {
                        chart.xAxis[0].setTitle({
                            text: 'Ngày'
                        })
                    }
                }
            },
            credits: {
                enabled: false
            },
            time: {
                useUTC: false,
            },
            title: {
                text: 'Số lượng theo ngày'
            },
            rangeSelector: {
                selected: 5,
                inputEnabled: false,
                inputDateFormat: '%Y-%m-%d',
                inputEditDateFormat: '%Y-%m-%d',
                inputDateParser: function (value) {
                    var ti = new Date(value)
                    ti.setHours(ti.getHours() + 7)
                    return Date.UTC(ti.getUTCFullYear(), ti.getUTCMonth(), ti.getUTCDate())
                },
                buttons: [{
                    type: 'all',
                    text: 'All'
                }],
                buttonTheme: {
                    // width: 60
                },
                inputBoxBorderColor: '#ccc',
                inputBoxWidth: 120,
                inputBoxHeight: 18,
                inputStyle: {
                    color: '#3c8dbc',
                    fontWeight: 'bold'
                },
            },
            yAxis: [{
                showFirstLabel: !1,
                showLastLabel: !1,
                // tickPixelInterval: 50,
                endOnTick: !0,
                title: {
                    text: 'Number'
                },
                opposite: !1,
                gridLineColor: "#eeeeee",
                gridLineWidth: 0.5,
                zIndex: 1,
                labels: {
                    style: {
                        color: "#999999"
                    }
                },
                minTickInterval: 1,
            }],
            xAxis: [{
                type: 'datetime',
                title: {
                    text: 'Ngày'
                },
                tickmarkPlacement: "off",
                gridLineWidth: 0,
                labels: {
                    style: {
                        color: "#999999"
                    },
                    rotation: -30,
                    formatter: function () {
                        return moment(this.value).format('YYYY-MM-DD')
                    }
                },
                // ordinal: false,
                startOnTick: false,
                endOnTick: false,
                minPadding: 0,
                maxPadding: 0,
                minRange: 24 * 3600 * 1000,
                minTickInterval: 24 * 3600 * 1000,
                // tickInterval: 24 * 3600 * 1000, //1day
                events: {
                    setExtremes: function (event) {
                        minDateFilter = event.min;
                        maxDateFilter = event.max;

                        if (table) {
                            table.draw();
                        }
                    }
                }
            }],
            tooltip: {
                xDateFormat: '%Y-%m-%d',
                shadow: false,
                shared: true,
                crosshairs: true,
                split: false,
                useHTML: true,
                headerFormat: '<h4 style="text-align: center">{point.key}</h4><table>',
                // pointFormat: '<tr style="color: {series.color}"><td><b style="width:1000px;">{series.name}</b>: </td>' +
                //     '<td style="text-align: right"><b>{point.y}{series.tooltip.valueSuffix}</b> ({point.percentage:.0f}%)</td></tr>',
                footerFormat: '</table>',
                pointFormatter: function () {
                    var lbel = ''
                    if (this.series.userOptions.type === 'column') {
                        lbel = percentFormat.display(this.percentage)
                    }
                    return '<tr style="color:' + this.color + '"><td><b style="width:1000px;">' + this
                        .series.name + '</b>: </td>' +
                        '<td style="text-align: right"><b> ' + (lbel || this.y) + '</b>'
                }
            },
            legend: {
                enabled: true,
                // layout: 'vertical',
                align: 'center',
                // verticalAlign: 'middle',
                itemMarginTop: 7,
                itemMarginBottom: 7,
                // width: 150,
                labelFormatter: function () {
                    return '<p style="color: ' + this.color + '">' + this.name + '</p>';
                }
            },
            drilldown: {
                activeAxisLabelStyle: {
                    textDecoration: 'none',
                },
                activeDataLabelStyle: {
                    textDecoration: 'none',
                },
            },
            plotOptions: {
                series: {
                    borderWidth: 0,
                    dataLabels: {
                        enabled: false,
                        useHTML: true,
                        formatter: function () {
                            return '<span style="color: ' + this.color + '">' + this.y + '</span>';
                        }
                    },
                    // compare: 'percent',
                    showInNavigator: true,
                    events: {
                        legendItemClick: function () {
                            chart.showLoading()
                            // if (table) {
                            //     // Get the column API object
                            //     var column = table.column(this.index + 1);
                            //     // Toggle the visibility
                            //     column.visible(!column.visible());
                            // }
                            var $cb = $dropMenu.eq(0).find('input[type=checkbox]:eq(' + this.index + ')')
                            if ($cb.length) $cb[0].checked = !$cb[0].checked
                            chart.hideLoading()
                        }
                    }
                },
                column: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function (e) {
                                var drilldown = this.drilldown;
                                if (drilldown) {
                                    chart.showLoading();
                                    setTimeout(function () {
                                        chart.hideLoading();
                                        for (var i = 0; i < drilldown.length; i++) {
                                            chart.addSingleSeriesAsDrilldown(e.point, drilldown[i])
                                        }
                                        chart.applyDrilldown();
                                    }, 100);
                                    chart.xAxis[0].setTitle({
                                        text: this.series.name
                                    })
                                }
                            }
                        }
                    },
                },
            },
            navigator: {
                enabled: false,
                margin: 20,
                // height: 50
            },
            scrollbar: {
                enabled: false
            },
            responsive: {
                rules: [{
                    condition: {
                        maxWidth: 900
                    },
                    chartOptions: {
                        legend: {
                            enabled: true,
                            layout: 'horizontal',
                            align: 'center',
                            verticalAlign: 'bottom',
                            maxHeight: 150,
                        }
                    }
                }]
            },
            lang: {
                noData: "No data to show"
            },
            noData: {
                style: {
                    position: "absolute",
                    backgroundColor: "#ffffff",
                    opacity: 0.5,
                    textAlign: "center",
                    fontSize: 15,
                }
            },
            exporting: {
                buttons: {
                    contextButton: {
                        menuItems: ["viewFullscreen", "printChart", "separator", "downloadPNG", "downloadJPEG",
                            "separator", "downloadXLS"
                        ]
                    }
                },
                filename: '<%=translate(mod_module + "." + mod_alias)%>_chart_<%=helpers.date.format()%>',
                csv: {
                    dateFormat: '%Y-%m-%d',
                },
                chartOptions: {
                    chart: {
                        events: null
                    }
                },
                sourceWidth: 1400,
                sourceHeight: 600,
            },
        });

        chart.hideNoData();
        chart.showLoading('Loading data from server...');
    }

    $(document).ready(function () {

        initializeChart()

        $.fn.DataTable.ext.pager.numbers_length = 7;

        $.fn.dataTableExt.afnFiltering.push(
            function (oSettings, aData, iDataIndex) {
                if (typeof aData._date == 'undefined') {
                    aData._date = moment(aData[0]).valueOf();
                }
                if (minDateFilter && !isNaN(minDateFilter)) {
                    if (aData._date < minDateFilter) {
                        return false;
                    }
                }
                if (maxDateFilter && !isNaN(maxDateFilter)) {
                    if (aData._date > maxDateFilter) {
                        return false;
                    }
                }
                return true;
            }
        );

        // custom chart metrics
        $dropMenu.eq(0).on('change', 'input[type=checkbox]', function (e) {
            e.preventDefault()
            var col = parseInt(e.target.dataset.col)
            var show = this.checked
            if (table) {
                var column = table.column(col + 1);
                column.visible() != show && column.visible(show);
            }
            return false
        })

        $('.btn-type-chart').on('click', function (e) {
            e.preventDefault();
            $(this).siblings('button').removeClass('hidden');
            $(this).addClass('hidden');
            changeType(chart, $(this).data('type'));
        })
    })
</script>
