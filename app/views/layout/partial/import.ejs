<%- include('../../layout/admin/_head') -%>
<script src="<%=publicUrl%>admin/js/exceljs-4.3.0.min.js?v=<%=_versionCache%>"></script>
<!-- Content Header (Page header) -->
<section class="content-header form-inline">
    <h1>Import <%=mod_alias%><small><a href="<%= mod_url%>"><i class="fa fa-reply"></i></a></small></h1>
    <ol class="breadcrumb">
        <li><a href="<%= mod_url%>"><i class="fa fa-dashboard"></i> Dashboard</a></li>
        <li class="active"><%=mod_alias%></li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <% if (typeof(valid_errors) != 'undefined' && valid_errors.length > 0) { %>
    <section class="content-header">
        <div class="alert alert-danger alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
            <% valid_errors.forEach(function(error){ %>
            <p><i class="icon fa fa-warning"></i> <%= error%> </p>
            <% }); %>
        </div>
    </section>
    <% } %>
    <div class="row">
        <div class="col-lg-12">
            <div class="box">
                <div class="box-body table-responsive">
                    <table class="table table-striped table-bordered table-hover dataTable">
                        <tbody>
                        <tr>
                            <td><label for="file">Excel file</label></td>
                            <td>
                                <div class="resum">
                                    <div class="inputfile-container" style="margin-top: 3px">
                                        <input type="file" id="uploadfile">
                                        <label for="uploadfile"></label>
                                    </div>
                                    <div class="btn btn-primary" id="start-import">Start</div>
                                </div>
                            </td>
                        </tr>
                        <tr style="display: none;">
                            <td><label>Result</label></td>
                            <td>
                                <div class="box-body table-responsive" id="result-import"></div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    window.addEventListener('DOMContentLoaded', function () {
        //pushData();
        var btnStart = document.getElementById('start-import')
        var uploads = document.getElementById("uploadfile");
        var header = []
        var data = []
        var result = {}
        var iTime = 0;
        uploads.addEventListener('change', function (e) {
            let files = e.target.files;
            let file_data = files[0];
            //e.target.value = '';
            $('#start-import').show();
        })
        btnStart.addEventListener('click',function(e){
            e.preventDefault();
            const file_data = document.getElementById('uploadfile').files[0];
            if(!file_data){
                Admin.loading_show('Select file',1);
                return false;
            }
            if(file_data.type != 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'){
                Admin.loading_show('Only accept excel file',1);
                return false;
            }
            //50MB
            if(file_data.size > 60000000){
                Admin.loading_show('File maximum 50M',1);
                return false;
            }

            $('#result-import').closest('tr').show()
            $('#start-import').hide();
            let lastRow = 0;
            let clusterImport = 500
            let from = 0
            let to = 0 
            const workbook = new ExcelJS.Workbook()
            const reader = new FileReader()
            reader.readAsArrayBuffer(file_data)
            reader.onload = () => {
                const buffer = reader.result;
                workbook.xlsx.load(buffer).then(workbook => {
                    //console.log(workbook, 'workbook instance')
                    workbook.eachSheet((sheet, id) => {
                        lastRow = sheet.lastRow.number
                        console.log('lastRow',lastRow)
                        sheet.eachRow((row, rowIndex) => {
                            //console.log(row.values, rowIndex)
                            if(rowIndex == 1){
                                for(let i=1;i<row.values.length;i++){
                                    header.push(row.values[i])
                                }
                            } else {
                                var tmp = {};
                                header.forEach((col,i) => {
                                    tmp[col] = row.values[i+1];
                                });

                                data.push(tmp)
                                if(rowIndex % clusterImport == 0){
                                    from = rowIndex-clusterImport+1;
                                    to = rowIndex;
                                    pushData(data,from,to)
                                    data = []
                                }
                            }

                            if(rowIndex >= lastRow){
                                //console.log('END',data)
                                if(data.length > 0){
                                    from = 2;
                                    if(lastRow > clusterImport){
                                        from = lastRow-clusterImport+1;
                                    }
                                    pushData(data,from,lastRow)
                                    data = []    
                                }
                            }
                        })
                    })
                })
            }
        });

        function pushData(data,from,to){
            iTime += 500
            console.log(from,to,data)
            setTimeout(async function(){
                let r = await importData(data,from,to)
                $('#result-import').prepend(r)
            },iTime)
        }

        function importData(data,from,to){
            return new Promise((resolve, reject) => {
                let data_post = {
                    _csrf : token_value,
                    data : JSON.stringify(data)
                }
                $.ajax({
                    url: `<%=mod_url%>/import`,
                    type: 'POST',
                    data: data_post,
                    dataType:'json',
                    success: function(res) {
                        let result = `${from}-${to}: ${res.status}<br>`
                        resolve(result)
                    },
                    error: function(e) {
                        console.log(e);
                        reject(error)
                    }
                });
            })
        }        
    })
</script>
</div><!--/.content-wrapper-->
<%- include('../../layout/admin/_footer') -%>
<%- include('../../layout/admin/_end') -%>