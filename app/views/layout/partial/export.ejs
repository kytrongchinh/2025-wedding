<%- include('../../layout/admin/_head') -%>
<!-- Content Header (Page header) -->
<section class="content-header form-inline">
    <h1>Export <%=mod_alias%><small><a href="<%= mod_url%>"><i class="fa fa-reply"></i></a></small></h1>
    <ol class="breadcrumb">
        <li><a href="<%= mod_url%>"><i class="fa fa-dashboard"></i> Dashboard</a></li>
        <li class="active"><%=mod_alias%></li>
    </ol>
</section>

<section class="content-header">
    <div class="form-group form-inline">
    </div>
</section>

<!-- Main content -->
<section class="content">
    <% if (typeof(valid_errors) != 'undefined' && valid_errors.length > 0) { %>
    <section class="content-header">
        <div class="alert alert-danger alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
            <% valid_errors.forEach(function(error){ %>
            <p><i class="icon fa fa-warning"></i> <%= error%> </p>
            <% }); %>
        </div>
    </section>
    <% } %>
    <div class="row">
        <div class="col-lg-12">
            <div class="box">
                <div class="box-body table-responsive">
                    <form method="post" id="frmExport">
                    <table class="table table-striped table-bordered table-hover dataTable">
                        <tbody>
                        <tr>
                            <td><label>Column</label></td>
                            <td>
                                <div class="form-group form-inline">
                                <% field_keys.forEach(function(field,i){%>
                                    <% var fields_type = fields[field]; %>
                                    <div class="checkbox">
                                        <input onchange="handleCheckbox(this);" id="checkbox_<%=field%>" checked class="styled sl-column" type="checkbox" data-type="<%=fields_type%>" value="<%=field%>">
                                        <label for="checkbox_<%=field%>"><%=field%></label>
                                    </div>
                                <%});%>
                            </div>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>
                                <button type="button" class="btn btn-primary" id="btn-export">Export</button>&nbsp;&nbsp;&nbsp;
                            </td>
                        </tr>
                        <% field_keys.forEach(function(field,k){%>
                        <% var fields_type = fields[field]; %>
                        <tr class="row-<%=field%>" data="<%=fields_type%>">
                            <td><label for="file"><%=field%></label></td>
                            <td>
                                <% if(fields_type == 'Date'){ %>
                                <div class="form-group form-inline">
                                    <input type="hidden" name="<%=field%>">
                                    <input type="text" name="<%=field%>_from"  value="" class="form-control small datepicker" placeholder="From">
                                    <input type="text" name="<%=field%>_to"  value="" class="form-control small datepicker" placeholder="To">
                                </div>
                                <%}else if(fields_type == 'Boolean'){%>
                                    <select class="form-control small" id="<%= field%>" name="<%= field%>">
                                        <option value=""></option>
                                        <option value="true">True</option>
                                        <option value="false">False</option>
                                    </select>
                                <%}else if(fields_type == 'Number'){%>
                                    <input type="number" class="form-control small" value="" name="<%=field%>"/>
                                <%}else if(fields_type == 'String'){%>
                                    <div class="form-group form-inline">
                                        <select class="form-control minimum" name="<%=field%>_query_type">
                                            <option></option>
                                            <option>equal</option>
                                            <option>like</option>
                                        </select>
                                        <input type="text" class="form-control small" value="" name="<%=field%>"/>
                                    </div>
                                <%}else{%>
                                    <input type="text" class="form-control small" value="" name="<%=field%>"/>
                                <%}%>
                            </td>
                        </tr>
                        <%});%>
                        </tbody>
                    </table>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="<%=_staticUrl%>public/admin/js/exceljs-4.3.0.min.js"></script>

<script type="text/javascript">
    var f_end = false;
    var c_data = 0;
    $(document).ready(() => {
        $('#btn-export').on('click',function(e){
            let url = $(this).data('url-export');
            Admin.loading_show('Waiting');
            startExport()
        })
    })

    function startExport(){
        var data = {};
        $('.sl-column').each(function(k,el){
            if(el.checked){
                var field = el.value;
                var field_type = $(el).data('type');
                if(field_type == 'Date'){
                    var from_date = $('.row-'+field).find('input[name="'+field+'_from"]').val();
                    var to_date = $('.row-'+field).find('input[name="'+field+'_to"]').val();
                    data[field] = {type:field_type,from:from_date,to:to_date};
                }else if(field_type == 'Boolean'){
                    var value = $('.row-'+field).find('select[name="'+field+'"]').val();
                    data[field] = {type:field_type,value:value};
                }else if(field_type == 'String'){
                    var query_type = $('.row-'+field).find('select[name="'+field+'_query_type"]').val();
                    var value = $('.row-'+field).find('input[name="'+field+'"]').val();
                    data[field] = {type:field_type,search:query_type,value:value};
                }else{
                    var value = $('.row-'+field).find('input[name="'+field+'"]').val();
                    data[field] = {type:field_type,value:value};
                }
            }
        });

        let field_keys_export = Object.keys(data);
        let colum_width = []
        for(let i=0;i<field_keys_export.length;i++){
            colum_width.push({ key: field_keys_export[i], width: 30 })
        }
        var wb = new ExcelJS.Workbook();
        var ws = wb.addWorksheet('Sheet 0');
        var row = null;
        ws.columns = colum_width;
        
        // //write data header
        // row = ws.addRow(["Title"]);
        // row.eachCell(function(cell) {
        //     cell.fill = {
        //         type: 'pattern',
        //         pattern: 'solid',
        //         fgColor: {argb: '96C8FB'},
        //         bgColor: { argb: '96C8FB' }
        //     };
        //     cell.font = {
        //         name: 'Calibri',
        //         size: 12,
        //         bold: false
        //     }
        // });
        // ws.mergeCells('A1:D1');

        row = ws.addRow(field_keys_export);
        row.eachCell(function(cell) {
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: {argb: '96C8FB'},
                bgColor: {argb: '96C8FB' }
            };
        });

        var data_post = {
            _csrf : token_value,
            offset : 1,
            data  :  JSON.stringify(data)
        };

        handleData(data_post,wb,ws)
    }

    function handleData(data_post,wb,ws){
        if(f_end) return
        $.ajax({
            url: `<%=mod_url%>/export`,
            type: 'POST',
            data: data_post,
            success: function(res) {
                //console.log(res)
                //return;
                if(res.error == 0){
                    if(res.data && res.data.length > 0){
                        for(let i=0; i< res.data.length;i++){
                            ws.addRow(res.data[i]);
                            c_data++
                        }
                        //paging
                        data_post.offset = data_post.offset + 1
                        if(c_data != 0 && (c_data % 1000000) === 0){
                            ws = wb.addWorksheet(`Sheet ${c_data / 1000000}`);
                        }
                        //continue call after 1s
                        setTimeout(function(){ handleData(data_post,wb,ws) },100)
                    }else{
                        Admin.loading_hide();
                        f_end = true;
                        //export file
                        wb.xlsx.writeBuffer( {
                            base64: true
                        }).then( function (xls64) {
                            // build anchor tag and attach file (works in chrome)
                            var filename = `<%=mod_resource%>_${Date.now()}`;
                            var a = document.createElement("a");
                            var data = new Blob([xls64], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                            var url = URL.createObjectURL(data);
                            a.href = url;
                            a.download = `data_${filename}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(function() {document.body.removeChild(a);window.URL.revokeObjectURL(url);},0);
                            
                        }).catch(function(e) {
                            console.log(e.message);
                        });
                    }
                }else{
                    console.log(res.msg);
                }
            },
            error: function(e) {
                console.log(e);
            }
        });
    }

    function handleCheckbox(el){
        var val = el.value;
        if(el.checked){
            $('.row-'+val).show();
        }else{
            $('.row-'+val).hide();
        }
    }
</script>
</div><!--/.content-wrapper-->
<%- include('../../layout/admin/_footer') -%>
<%- include('../../layout/admin/_end') -%>